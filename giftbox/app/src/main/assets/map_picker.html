<!DOCTYPE html>
<html>
<head>
    <title>Pick Delivery Location</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body { height: 100%; overflow: hidden; font-family: sans-serif; }
        #map { height: 100vh; width: 100vw; }

        .search-box {
            position: absolute;
            top: 20px;
            left: 10px;
            right: 10px;
            z-index: 9999;
            background: white;
            border-radius: 8px;
            padding: 2px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }

        /* Search bar container logic */
        .search-container {
            display: flex;
            align-items: center;
            background: white;
            border-radius: 8px;
        }

        #search-input {
            flex: 1;
            border: none;
            padding: 12px;
            outline: none;
            font-size: 14px;
            color: #333;
        }

        .search-btn {
            background: none;
            border: none;
            padding: 10px;
            cursor: pointer;
            font-size: 18px;
        }

        .gps-btn {
            position: absolute; bottom: 100px; right: 20px;
            width: 50px; height: 50px; background: white;
            border-radius: 50%; border: none; z-index: 1000;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
            cursor: pointer; font-size: 24px; display: flex;
            align-items: center; justify-content: center;
        }

        .confirm-btn {
            position: absolute; bottom: 30px; left: 50%;
            transform: translateX(-50%); width: 80%; height: 50px;
            background: #764ba2; color: white; border: none;
            border-radius: 25px; font-weight: bold; z-index: 1000;
            opacity: 0.6; pointer-events: none;
        }
        .confirm-btn.ready { opacity: 1; pointer-events: auto; }
        .pin { font-size: 40px !important; text-align: center; }
    </style>
</head>
<body>

<div id="map"></div>

<div class="search-box">
    <div class="search-container">
        <input id="search-input" type="text" placeholder="Search place (e.g. Bharatpur)...">
        <button class="search-btn" onclick="searchByName()">üîç</button>
    </div>
</div>

<button class="gps-btn" onclick="useDeviceLocation()">üéØ</button>

<button class="confirm-btn" id="confirm-btn" onclick="confirmLocation()">CONFIRM SELECTION</button>

<script>
    let map, currentMarker;
    let currentLat, currentLng;
    let locationSelected = false;

    // Initialize Map - Centered on Nepal
    map = L.map('map', { zoomControl: false }).setView([27.7, 85.3], 7);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

    map.on('click', e => {
        handleNewSelection(e.latlng);
    });

    // SEARCH BY NAME FUNCTION
    function searchByName() {
        const query = document.getElementById('search-input').value;
        if (query.length < 3) {
            alert("Please enter a longer name to search.");
            return;
        }

        // Nominatim requires a User-Agent header or it may block the request
        fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=1`, {
            headers: { 'User-Agent': 'GiftBoxApp/1.0' }
        })
        .then(response => response.json())
        .then(results => {
            if (results && results.length > 0) {
                const latlng = {
                    lat: parseFloat(results[0].lat),
                    lng: parseFloat(results[0].lon)
                };
                handleNewSelection(latlng);
            } else {
                alert("Location not found.");
            }
        })
        .catch(err => alert("Search failed. Check internet connection."));
    }

    // Trigger search on "Enter" key
    document.getElementById('search-input').addEventListener("keyup", function(event) {
        if (event.key === "Enter") searchByName();
    });

    // Device GPS Logic
    function useDeviceLocation() {
        if (window.Android && window.Android.requestSystemGPS) {
            window.Android.requestSystemGPS();
        } else {
            executeGPS();
        }
    }

    function executeGPS() {
        document.getElementById('search-input').value = "Locating you...";
        navigator.geolocation.getCurrentPosition(
            (position) => {
                const latlng = {
                    lat: position.coords.latitude,
                    lng: position.coords.longitude
                };
                handleNewSelection(latlng);
            },
            (error) => alert("Could not get location. Ensure GPS is ON."),
            { enableHighAccuracy: true }
        );
    }

    // Called from Android native code
    function setLocationFromAndroid(lat, lng) {
        handleNewSelection({ lat: lat, lng: lng });
    }

    function handleNewSelection(latlng) {
        // Validate location is within Nepal (26.38 to 30.45 N, 80.08 to 88.12 E)
        const lat = latlng.lat;
        const lng = latlng.lng;

        if (lat < 26.38 || lat > 30.45 || lng < 80.08 || lng > 88.12) {
            alert("Please select a location within Nepal only.");
            return;
        }

        if (currentMarker) map.removeLayer(currentMarker);

        currentLat = latlng.lat;
        currentLng = latlng.lng;
        locationSelected = true;

        currentMarker = L.marker(latlng, {
            icon: L.divIcon({ html: 'üìç', className: 'pin', iconAnchor: [20, 40] })
        }).addTo(map);

        map.flyTo(latlng, 17);
        document.getElementById('confirm-btn').classList.add('ready');
        reverseGeocode(latlng.lat, latlng.lng);
    }

    function reverseGeocode(lat, lng) {
        const displayField = document.getElementById('search-input');
        currentLat = lat;
        currentLng = lng;

        fetch(`https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lng}&format=json`, {
            headers: { 'User-Agent': 'GiftBoxApp/1.0' }
        })
        .then(r => r.json())
        .then(data => {
            const address = data.display_name || "Selected Location";
            // Shows Address + Coords in the search box
            displayField.value = `${address} (${lat.toFixed(5)}, ${lng.toFixed(5)})`;
        })
        .catch(() => {
            displayField.value = `${lat.toFixed(5)}, ${lng.toFixed(5)} (Offline)`;
        });
    }

    function confirmLocation() {
        if (!locationSelected) return;
        const addressString = document.getElementById('search-input').value;
        if (window.Android) {
            window.Android.onLocationSelected(currentLat, currentLng, addressString);
        }
    }
</script>
</body>
</html>